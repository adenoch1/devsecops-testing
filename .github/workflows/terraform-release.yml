name: terraform-release

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Choose what to run"
        required: true
        default: "deploy"
        type: choice
        options:
          - deploy
          - destroy

      container_image_tag:
        description: "Container tag to deploy (run-... / sha-...). Leave empty to use commit SHA."
        required: false
        default: ""

      smoke_path:
        description: "Path to test on the ALB (example: /health or /)"
        required: true
        default: "/health"
        type: string

permissions:
  id-token: write
  contents: read

concurrency:
  group: terraform-release-${{ github.ref }}
  cancel-in-progress: true

env:
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"
  TF_VERSION: "1.6.6"
  WORKDIR: "infra/envs/dev"

jobs:
  deploy:
    name: Deploy (dev)
    if: ${{ inputs.action == 'deploy' }}
    runs-on: ubuntu-latest
    environment: dev

    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}

    outputs:
      alb_dns_name: ${{ steps.capture.outputs.alb_dns_name }}
      smoke_path: ${{ steps.capture.outputs.smoke_path }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_APPLY }}
          aws-region: ${{ secrets.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init
        run: terraform init -input=false

      - name: Resolve container image tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${{ inputs.container_image_tag }}" ]; then
            TAG="${{ inputs.container_image_tag }}"
          else
            TAG="${GITHUB_SHA}"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Using container_image_tag=$TAG"

      - name: Terraform plan
        run: terraform plan -out=tfplan.binary -var="container_image_tag=${{ steps.tag.outputs.tag }}"

      - name: Terraform apply
        run: terraform apply -auto-approve tfplan.binary

      - name: Capture ALB DNS + validate
        id: capture
        shell: bash
        run: |
          set -euo pipefail

          echo "smoke_path=${{ inputs.smoke_path }}" >> "$GITHUB_OUTPUT"

          echo "Terraform outputs:"
          terraform output || true

          # Try common output keys first (fast)
          ALB=""
          for key in alb_dns_name load_balancer_dns_name lb_dns_name dns_name; do
            if terraform output -raw "$key" >/dev/null 2>&1; then
              v="$(terraform output -raw "$key" | tr -d '\r\n\t ')"
              if [ -n "$v" ] && echo "$v" | grep -q "elb.amazonaws.com"; then
                ALB="$v"
                echo "Found ALB output key: $key"
                break
              fi
            fi
          done

          # Fallback: scan all outputs for an elb hostname
          if [ -z "$ALB" ]; then
            ALB="$(terraform output 2>/dev/null | grep -Eo '[a-zA-Z0-9-]+\.([a-z0-9-]+\.)?elb\.amazonaws\.com' | head -n1 || true)"
          fi

          if [ -z "$ALB" ]; then
            echo "ERROR: Could not find an ALB DNS name in terraform outputs."
            echo "Run locally: cd infra/envs/dev ; terraform output"
            exit 1
          fi

          echo "alb_dns_name=$ALB" >> "$GITHUB_OUTPUT"
          echo "ALB DNS: $ALB"

      - name: Show URLs
        shell: bash
        run: |
          set -euo pipefail
          echo "HTTPS: https://${{ steps.capture.outputs.alb_dns_name }}${{ inputs.smoke_path }}"
          echo "HTTP : http://${{ steps.capture.outputs.alb_dns_name }}${{ inputs.smoke_path }}"
          echo "ECR repo (if present):"
          terraform output -raw ecr_repository_url || true

  dns:
    name: DNS Smoke Test (dns)
    needs: deploy
    runs-on: ubuntu-latest
    environment: dns

    steps:
      - name: Assert ALB DNS is present
        shell: bash
        run: |
          set -euo pipefail
          echo "ALB from deploy outputs: '${{ needs.deploy.outputs.alb_dns_name }}'"
          if [ -z "${{ needs.deploy.outputs.alb_dns_name }}" ]; then
            echo "ERROR: ALB DNS output is empty from deploy job."
            exit 1
          fi

      - name: Wait for ALB propagation
        run: sleep 60

      - name: Smoke test (HTTPS then HTTP)
        shell: bash
        run: |
          set -euo pipefail
          ALB="${{ needs.deploy.outputs.alb_dns_name }}"
          PATH_ONLY="${{ needs.deploy.outputs.smoke_path }}"

          HTTPS_URL="https://${ALB}${PATH_ONLY}"
          HTTP_URL="http://${ALB}${PATH_ONLY}"

          echo "Testing HTTPS: $HTTPS_URL"
          code=$(curl -k -s -o /dev/null -w "%{http_code}" "$HTTPS_URL" || true)
          echo "HTTPS status: $code"
          if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ]; then
            echo "Smoke test passed on HTTPS."
            exit 0
          fi

          echo "Testing HTTP: $HTTP_URL"
          code=$(curl -s -o /dev/null -w "%{http_code}" "$HTTP_URL" || true)
          echo "HTTP status: $code"
          if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ]; then
            echo "Smoke test passed on HTTP."
            exit 0
          fi

          echo "Smoke test failed (expected 200/301/302)."
          exit 1

  destroy:
    name: Destroy (destroy)
    if: ${{ inputs.action == 'destroy' }}
    runs-on: ubuntu-latest
    environment: destroy

    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_APPLY }}
          aws-region: ${{ secrets.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init
        run: terraform init -input=false

      - name: Terraform destroy
        run: terraform destroy -auto-approve
