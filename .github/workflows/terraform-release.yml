name: terraform-release

on:
  push:
    branches: ["main"]
    paths:
      - "infra/**"
      - "modules/**"
      - "app/**"
      - "docker/**"
      - ".github/workflows/terraform-release.yml"
      - ".github/workflows/03-release.yml"

  workflow_dispatch:
    inputs:
      action:
        description: "deploy or destroy"
        required: true
        default: "deploy"
        type: choice
        options: [deploy, destroy]
      fqdn:
        description: "Custom domain to test (example: app.clevernews.org)"
        required: false
        default: "app.clevernews.org"
      smoke_path:
        description: "Path to test (example: /health)"
        required: true
        default: "/health"
        type: string

permissions:
  id-token: write
  contents: read

concurrency:
  group: terraform-release-${{ github.ref }}
  cancel-in-progress: true

env:
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"
  TF_VERSION: "1.6.6"
  WORKDIR: "infra/envs/dev"

jobs:
  #########################################################
  # Gate 1 (DEV): Bootstrap Infra (safe even before image)
  # - Creates ECR/VPC/ALB/etc
  # - Keeps ECS desired_count=0 to avoid image-pull failures
  #########################################################
  infra_bootstrap:
    name: Gate 1 — Infra Bootstrap (dev)
    if: ${{ github.event_name == 'push' || inputs.action == 'deploy' }}
    runs-on: ubuntu-latest
    environment: dev

    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_APPLY }}
          aws-region: ${{ secrets.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init
        run: terraform init -input=false

      - name: Terraform plan (bootstrap)
        run: |
          terraform plan \
            -out=tfplan.bootstrap \
            -var="container_image_tag=bootstrap" \
            -var="desired_count=0"

      - name: Terraform apply (bootstrap)
        run: terraform apply -auto-approve tfplan.bootstrap

      - name: Show outputs
        run: terraform output

  ########################################################
  # Build & Push Image (called AFTER infra exists)
  ########################################################
  build_image:
    name: Build + Push Image (ECR)
    needs: infra_bootstrap
    if: ${{ github.event_name == 'push' || inputs.action == 'deploy' }}
    uses: ./.github/workflows/03-release.yml
    secrets: inherit
    with:
      tfvars_path: "infra/envs/dev/terraform.tfvars"
      dockerfile_path: "docker/Dockerfile"
      build_context: "."
      image_tag: ${{ github.sha }}

  ########################################################
  # Deploy App: now that image exists, scale ECS up
  ########################################################
  deploy:
    name: Deploy (dev)
    needs: build_image
    if: ${{ github.event_name == 'push' || inputs.action == 'deploy' }}
    runs-on: ubuntu-latest
    environment: dev

    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_APPLY }}
          aws-region: ${{ secrets.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init
        run: terraform init -input=false

      - name: Terraform plan (deploy)
        run: |
          terraform plan \
            -out=tfplan.deploy \
            -var="container_image_tag=${{ needs.build_image.outputs.deploy_tag }}"

      - name: Terraform apply (deploy)
        run: terraform apply -auto-approve tfplan.deploy

      - name: Show outputs
        run: terraform output

  ########################################################
  # Gate 2 (DNS): external /health test
  ########################################################
  dns:
    name: Gate 2 — DNS Smoke Test
    needs: deploy
    if: ${{ github.event_name == 'push' || inputs.action == 'deploy' }}
    runs-on: ubuntu-latest
    environment: dns

    steps:
      - name: Resolve inputs
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "FQDN=${{ secrets.FQDN }}" >> $GITHUB_ENV
            echo "SMOKE_PATH=/health" >> $GITHUB_ENV
          else
            echo "FQDN=${{ inputs.fqdn }}" >> $GITHUB_ENV
            echo "SMOKE_PATH=${{ inputs.smoke_path }}" >> $GITHUB_ENV
          fi

      - name: Validate FQDN
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${FQDN}" ]; then
            echo "ERROR: FQDN is empty."
            echo "Fix for push-to-main runs: set repo or environment secret FQDN (example: app.clevernews.org)."
            exit 1
          fi
          echo "Testing https://${FQDN}${SMOKE_PATH}"

      - name: DNS resolution check
        shell: bash
        run: |
          set -euo pipefail
          for i in {1..12}; do
            echo "Attempt $i..."
            A="$(dig +short A "${FQDN}" || true)"
            CNAME="$(dig +short CNAME "${FQDN}" || true)"
            echo "A: ${A:-<none>}"
            echo "CNAME: ${CNAME:-<none>}"
            if [ -n "$A" ] || [ -n "$CNAME" ]; then
              echo "DNS resolves ✅"
              exit 0
            fi
            sleep 15
          done
          echo "ERROR: DNS did not resolve in time."
          exit 1

      - name: HTTPS smoke test (/health)
        shell: bash
        run: |
          set -euo pipefail

          PATH_ONLY="${SMOKE_PATH}"
          if [[ "$PATH_ONLY" != /* ]]; then
            PATH_ONLY="/$PATH_ONLY"
          fi

          URL="https://${FQDN}${PATH_ONLY}"
          echo "Testing URL: $URL"

          for i in {1..30}; do
            echo "Attempt $i..."
            code="$(curl -k -s -o /dev/null -w "%{http_code}" "$URL" || true)"
            echo "HTTP status: $code"

            if [[ "$code" =~ ^2[0-9][0-9]$ ]] || [[ "$code" =~ ^3[0-9][0-9]$ ]]; then
              echo "DNS gate passed ✅"
              exit 0
            fi

            sleep 20
          done

          echo "ERROR: DNS gate failed (endpoint not healthy/reachable)."
          exit 1

  ########################################################
  # Gate 3 (DESTROY): requires manual approval via env
  # - Disables ALB deletion protection JUST-IN-TIME
  # - Waits for AWS to release any public mappings (eventual consistency)
  # - Then terraform destroy
  ########################################################
  destroy_after_deploy:
    name: Gate 3 — Destroy (after deploy)
    needs: dns
    if: ${{ github.event_name == 'push' || inputs.action == 'deploy' }}
    runs-on: ubuntu-latest
    environment: destroy

    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_APPLY }}
          aws-region: ${{ secrets.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init
        run: terraform init -input=false

      - name: Disable ALB deletion protection (controlled teardown)
        shell: bash
        run: |
          set -euo pipefail
          if terraform output -raw alb_arn >/dev/null 2>&1; then
            ALB_ARN="$(terraform output -raw alb_arn)"
            echo "Disabling deletion protection for: $ALB_ARN"
            aws elbv2 modify-load-balancer-attributes \
              --load-balancer-arn "$ALB_ARN" \
              --attributes Key=deletion_protection.enabled,Value=false
          else
            echo "No alb_arn output found (maybe already destroyed). Skipping."
          fi

      - name: Wait for AWS to release public IP mappings (IGW safety)
        shell: bash
        run: |
          set -euo pipefail

          if ! terraform output -raw vpc_id >/dev/null 2>&1; then
            echo "VPC ID not found in terraform outputs. Skipping wait."
            exit 0
          fi

          VPC_ID="$(terraform output -raw vpc_id)"
          echo "Waiting for AWS to fully release public mappings in VPC: $VPC_ID"

          for i in {1..40}; do
            COUNT="$(aws ec2 describe-network-interfaces \
              --filters Name=vpc-id,Values="$VPC_ID" \
              --query "length(NetworkInterfaces[?Association.PublicIp!=null])" \
              --output text)"

            echo "Attempt $i — public ENIs with public IPs: $COUNT"

            if [ "$COUNT" = "0" ]; then
              echo "AWS cleanup complete ✅"
              exit 0
            fi

            sleep 15
          done

          echo "WARNING: AWS cleanup timeout reached, proceeding anyway"

      - name: Terraform destroy
        run: terraform destroy -auto-approve -parallelism=1

  ###############################################
  # Standalone destroy (manual)
  ###############################################
  destroy_only:
    name: Destroy (standalone)
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.action == 'destroy' }}
    runs-on: ubuntu-latest
    environment: destroy

    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_APPLY }}
          aws-region: ${{ secrets.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init
        run: terraform init -input=false

      - name: Disable ALB deletion protection (controlled teardown)
        shell: bash
        run: |
          set -euo pipefail
          if terraform output -raw alb_arn >/dev/null 2>&1; then
            ALB_ARN="$(terraform output -raw alb_arn)"
            echo "Disabling deletion protection for: $ALB_ARN"
            aws elbv2 modify-load-balancer-attributes \
              --load-balancer-arn "$ALB_ARN" \
              --attributes Key=deletion_protection.enabled,Value=false
          else
            echo "No alb_arn output found (maybe already destroyed). Skipping."
          fi

      - name: Wait for AWS to release public IP mappings (IGW safety)
        shell: bash
        run: |
          set -euo pipefail

          if ! terraform output -raw vpc_id >/dev/null 2>&1; then
            echo "VPC ID not found in terraform outputs. Skipping wait."
            exit 0
          fi

          VPC_ID="$(terraform output -raw vpc_id)"
          echo "Waiting for AWS to fully release public mappings in VPC: $VPC_ID"

          for i in {1..40}; do
            COUNT="$(aws ec2 describe-network-interfaces \
              --filters Name=vpc-id,Values="$VPC_ID" \
              --query "length(NetworkInterfaces[?Association.PublicIp!=null])" \
              --output text)"

            echo "Attempt $i — public ENIs with public IPs: $COUNT"

            if [ "$COUNT" = "0" ]; then
              echo "AWS cleanup complete"
              exit 0
            fi

            sleep 15
          done

          echo "WARNING: AWS cleanup timeout reached, proceeding anyway"

      - name: Terraform destroy
        run: terraform destroy -auto-approve -parallelism=1
