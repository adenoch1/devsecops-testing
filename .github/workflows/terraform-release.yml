name: terraform-release

on:
  push:
    branches: ["main"]
    paths:
      - "infra/**/*.tf"
      - "infra/**/terraform.tfvars"
      - ".github/workflows/terraform-release.yml"

  workflow_dispatch:
    inputs:
      action:
        description: "Choose what to run"
        required: true
        default: "deploy_test_destroy"
        type: choice
        options:
          - deploy_test_destroy
          - destroy_only

permissions:
  id-token: write
  contents: read

jobs:
  apply:
    if: ${{ github.event_name == 'push' || inputs.action == 'deploy_test_destroy' }}
    runs-on: ubuntu-latest
    environment: dev

    defaults:
      run:
        working-directory: infra/envs/dev

    outputs:
      alb_dns_name: ${{ steps.get_outputs.outputs.alb_dns_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform init
        run: terraform init -input=false

      # ------------------------------------------------------------
      # Step 1: "Prime" resources that S3 destination validation needs
      # This avoids: InvalidArgument: Unable to validate destination configurations
      # ------------------------------------------------------------
      - name: Terraform apply (step 1 - prime S3->SQS prerequisites)
        run: |
          set -euo pipefail
          terraform apply -input=false -auto-approve \
            -target=module.logging.aws_kms_key.sqs_sse \
            -target=module.logging.aws_kms_alias.sqs_sse \
            -target=module.logging.aws_sqs_queue.alb_logs_events \
            -target=module.logging.aws_sqs_queue_policy.alb_logs_events \
            -target=module.logging.aws_s3_bucket.alb_logs \
            -target=module.logging.aws_s3_bucket.alb_logs_access \
            -target=module.logging.aws_s3_bucket_policy.alb_logs \
            -target=module.logging.aws_s3_bucket_public_access_block.alb_logs \
            -target=module.logging.aws_s3_bucket_public_access_block.alb_logs_access \
            -target=module.logging.aws_s3_bucket_server_side_encryption_configuration.alb_logs \
            -target=module.logging.aws_s3_bucket_server_side_encryption_configuration.alb_logs_access \
            -target=module.logging.aws_s3_bucket_versioning.alb_logs \
            -target=module.logging.aws_s3_bucket_versioning.alb_logs_access

      - name: Wait for AWS propagation (SQS policy / KMS grants)
        run: |
          echo "Waiting for AWS propagation..."
          sleep 90

      # ------------------------------------------------------------
      # Step 2: Full plan/apply (includes S3 bucket notifications)
      # ------------------------------------------------------------
      - name: Terraform plan (full)
        run: terraform plan -input=false -out=tfplan.binary

      - name: Terraform apply (full - after approval)
        run: terraform apply -input=false -auto-approve tfplan.binary

      - name: Get Terraform outputs
        id: get_outputs
        run: |
          echo "alb_dns_name=$(terraform output -raw alb_dns_name)" >> "$GITHUB_OUTPUT"

      - name: Show ALB DNS name (copy this into GoDaddy CNAME for app)
        run: |
          echo "ALB DNS NAME:"
          echo "${{ steps.get_outputs.outputs.alb_dns_name }}"

  dns_gate:
    if: ${{ github.event_name == 'push' || inputs.action == 'deploy_test_destroy' }}
    runs-on: ubuntu-latest
    needs: apply
    environment: dns
    steps:
      - name: Pause for DNS change (GoDaddy)
        run: |
          echo "GoDaddy DNS update required:"
          echo "Type: CNAME"
          echo "Host: app"
          echo "Points to: ${{ needs.apply.outputs.alb_dns_name }}"
          echo "After saving, approve this environment to continue."

  https_test:
    if: ${{ github.event_name == 'push' || inputs.action == 'deploy_test_destroy' }}
    runs-on: ubuntu-latest
    needs: dns_gate
    steps:
      - name: HTTPS test (app.clevernews.org)
        run: |
          set -e
          URL="https://app.clevernews.org"
          echo "Testing $URL"
          for i in {1..30}; do
            if curl -fsS -m 10 "$URL" >/dev/null; then
              echo "✅ HTTPS OK"
              exit 0
            fi
            echo "Waiting for DNS/HTTPS... attempt $i/30"
            sleep 20
          done
          echo "❌ HTTPS test failed after retries"
          exit 1

  destroy_demo:
    if: ${{ github.event_name == 'push' || inputs.action == 'deploy_test_destroy' }}
    runs-on: ubuntu-latest
    needs: https_test
    environment: destroy

    defaults:
      run:
        working-directory: infra/envs/dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform init
        run: terraform init -input=false

      - name: Terraform destroy (cleanup)
        run: terraform destroy -input=false -auto-approve

  destroy_only:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.action == 'destroy_only' }}
    runs-on: ubuntu-latest
    environment: destroy

    defaults:
      run:
        working-directory: infra/envs/dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform init
        run: terraform init -input=false

      - name: Terraform destroy (cleanup)
        run: terraform destroy -input=false -auto-approve
