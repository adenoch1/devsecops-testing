name: terraform-release

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Choose what to run"
        required: true
        default: "deploy"
        type: choice
        options:
          - deploy
          - destroy

      container_image_tag:
        description: "Container tag to deploy (leave empty to use commit SHA)"
        required: false
        default: ""

      fqdn:
        description: "Your custom domain to test (example: app.clevernews.org)"
        required: false
        default: "app.clevernews.org"

      smoke_path:
        description: "Path to test on the endpoint (example: /health or /)"
        required: true
        default: "/"
        type: string

permissions:
  id-token: write
  contents: read

concurrency:
  group: terraform-release-${{ github.ref }}
  cancel-in-progress: true

env:
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"
  TF_VERSION: "1.6.6"
  WORKDIR: "infra/envs/dev"

jobs:
  ########################################################
  # DEV — Gate 1: Deploy Infra (Terraform Apply)
  ########################################################
  deploy:
    name: Deploy (dev)
    if: ${{ inputs.action == 'deploy' }}
    runs-on: ubuntu-latest
    environment: dev

    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # OIDC auth (this is where AWS access is required)
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_APPLY }}
          aws-region: ${{ secrets.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init
        run: terraform init -input=false

      - name: Resolve container image tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${{ inputs.container_image_tag }}" ]; then
            TAG="${{ inputs.container_image_tag }}"
          else
            TAG="${GITHUB_SHA}"
          fi
          echo "Using container_image_tag=$TAG"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Terraform plan
        run: terraform plan -out=tfplan.binary -var="container_image_tag=${{ steps.tag.outputs.tag }}"

      - name: Terraform apply
        run: terraform apply -auto-approve tfplan.binary

      - name: Show Terraform outputs (visibility)
        run: terraform output


  ########################################################
  # DNS — Gate 2: Production-style external verification
  # No AWS credentials. Validates the real user endpoint.
  ########################################################
  dns:
    name: DNS Gate (External Smoke Test)
    needs: deploy
    if: ${{ inputs.action == 'deploy' }}
    runs-on: ubuntu-latest
    environment: dns

    steps:
      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail
          FQDN="${{ inputs.fqdn }}"
          if [ -z "$FQDN" ]; then
            echo "ERROR: fqdn input is required for DNS gate (example: app.clevernews.org)."
            exit 1
          fi
          echo "FQDN set to: $FQDN"
          echo "Smoke path: ${{ inputs.smoke_path }}"

      - name: DNS resolution check
        shell: bash
        run: |
          set -euo pipefail
          FQDN="${{ inputs.fqdn }}"

          echo "Checking DNS resolution for: $FQDN"
          for i in {1..12}; do
            echo "Attempt $i..."
            # Try A/AAAA records (common) — some setups may not show CNAME directly.
            A="$(dig +short A "$FQDN" || true)"
            AAAA="$(dig +short AAAA "$FQDN" || true)"
            CNAME="$(dig +short CNAME "$FQDN" || true)"

            echo "A records:"
            echo "${A:-<none>}"
            echo "AAAA records:"
            echo "${AAAA:-<none>}"
            echo "CNAME records:"
            echo "${CNAME:-<none>}"

            if [ -n "$A" ] || [ -n "$AAAA" ] || [ -n "$CNAME" ]; then
              echo "DNS resolves ✅"
              exit 0
            fi

            echo "DNS not resolved yet. Sleeping 15s..."
            sleep 15
          done

          echo "ERROR: DNS did not resolve within retry window."
          exit 1

      - name: HTTPS smoke test (production truth)
        shell: bash
        run: |
          set -euo pipefail
          FQDN="${{ inputs.fqdn }}"
          PATH_ONLY="${{ inputs.smoke_path }}"

          # Make sure path begins with /
          if [[ "$PATH_ONLY" != /* ]]; then
            PATH_ONLY="/$PATH_ONLY"
          fi

          URL="https://${FQDN}${PATH_ONLY}"
          echo "Testing URL: $URL"

          # Retry window: ~3 minutes total (10 * 18s)
          for i in {1..10}; do
            echo "Attempt $i..."
            code="$(curl -k -s -o /dev/null -w "%{http_code}" "$URL" || true)"
            echo "HTTP status: $code"

            # Accept common “service is up” responses:
            # 200 OK (healthy), 301/302 redirect (still serving)
            if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ]; then
              echo "DNS gate passed ✅"
              exit 0
            fi

            sleep 18
          done

          echo "ERROR: DNS gate failed. Endpoint not healthy/reachable."
          exit 1


  ########################################################
  # DESTROY — Gate 3: Terraform Destroy
  ########################################################
  destroy:
    name: Destroy (destroy)
    if: ${{ inputs.action == 'destroy' }}
    runs-on: ubuntu-latest
    environment: destroy

    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # OIDC auth needed for destroy
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_APPLY }}
          aws-region: ${{ secrets.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init
        run: terraform init -input=false

      - name: Terraform destroy
        run: terraform destroy -auto-approve
