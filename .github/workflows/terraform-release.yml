name: Terraform Release

on:
  workflow_dispatch:
    inputs:
      action:
        description: "deploy or destroy"
        required: true
        default: deploy
      teardown_after_test:
        description: "Destroy infra after DNS test"
        required: true
        default: "true"

permissions:
  id-token: write
  contents: read

env:
  TF_VERSION: 1.6.6

########################################
# DEV – Infrastructure Creation
########################################

jobs:
  dev:
    if: inputs.action == 'deploy'
    environment: dev
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init
        working-directory: infra/envs/dev

      - name: Terraform Plan
        run: terraform plan -out=tfplan.binary
        working-directory: infra/envs/dev

      - name: Terraform Apply (Step 1)
        run: terraform apply -auto-approve tfplan.binary
        working-directory: infra/envs/dev

########################################
# DNS – Smoke Test (ALB DNS)
########################################

  dns:
    needs: dev
    environment: dns
    runs-on: ubuntu-latest

    steps:
      - name: Wait for ALB propagation
        run: sleep 60

      - name: Smoke Test ALB
        run: |
          echo "Test using ALB DNS:"
          echo "http://<your-alb-dns-name>"
          echo "Expect HTTP 200 or redirect to HTTPS"

########################################
# DESTROY – Automatic Cleanup
########################################

  destroy:
    if: inputs.teardown_after_test == 'true'
    needs: dns
    environment: destroy
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init
        working-directory: infra/envs/dev

      - name: Terraform Destroy
        run: terraform destroy -auto-approve
        working-directory: infra/envs/dev
