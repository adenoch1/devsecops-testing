name: terraform-release

on:
  push:
    branches: ["main"]
    paths:
      - "infra/**/*.tf"
      - "infra/**/terraform.tfvars"
      - ".github/workflows/terraform-release.yml"

  workflow_dispatch:
    inputs:
      action:
        description: "Choose what to run"
        required: true
        default: "deploy"
        type: choice
        options: [deploy, destroy]

      image_tag:
        description: "Container image tag to deploy (e.g., a git SHA). Leave empty to keep current."
        required: false
        default: ""

      two_step_apply:
        description: "Use two-step apply (prime S3->SQS prereqs, then full apply)"
        required: true
        default: "true"
        type: choice
        options: ["true", "false"]

      teardown_after_test:
        description: "Destroy infra after smoke test (for temporary testing)"
        required: true
        default: "false"
        type: choice
        options: ["true", "false"]

      smoke_path:
        description: "Path to test on the ALB (example: /health or /)"
        required: true
        default: "/health"
        type: string

  repository_dispatch:
    types: [terraform-deploy]

permissions:
  id-token: write
  contents: read

concurrency:
  group: terraform-release-${{ github.ref }}
  cancel-in-progress: true

env:
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"
  TF_VERSION: "1.6.6"
  WORKDIR: "infra/envs/dev"

jobs:
  ############################################################
  # DEPLOY (dev)
  ############################################################
  deploy:
    name: Deploy (dev)
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && inputs.action == 'deploy') ||
      (github.event_name == 'repository_dispatch' && github.event.action == 'terraform-deploy')
    runs-on: ubuntu-latest
    environment: dev

    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}

    outputs:
      alb_dns_name: ${{ steps.tf_outputs.outputs.alb_dns_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Verify AWS identity (STS)
        run: aws sts get-caller-identity

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init
        run: terraform init -input=false

      - name: Resolve inputs (image_tag / smoke_path / teardown / two_step)
        id: resolved
        shell: bash
        run: |
          set -euo pipefail

          # Defaults (manual)
          ACTION="deploy"
          IMAGE_TAG="${{ github.event_name == 'workflow_dispatch' && inputs.image_tag || '' }}"
          SMOKE_PATH="${{ github.event_name == 'workflow_dispatch' && inputs.smoke_path || '/health' }}"
          TEARDOWN="${{ github.event_name == 'workflow_dispatch' && inputs.teardown_after_test || 'false' }}"
          TWO_STEP="${{ github.event_name == 'workflow_dispatch' && inputs.two_step_apply || 'true' }}"

          # If triggered by repository_dispatch from 03-release.yml, override from payload
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            ACTION="${{ github.event.client_payload.action }}"
            IMAGE_TAG="${{ github.event.client_payload.image_tag }}"
            SMOKE_PATH="${{ github.event.client_payload.smoke_path }}"
            TEARDOWN="${{ github.event.client_payload.teardown_after_test }}"
            TWO_STEP="${{ github.event.client_payload.two_step_apply }}"
          fi

          echo "action=$ACTION" >> "$GITHUB_OUTPUT"
          echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"
          echo "smoke_path=$SMOKE_PATH" >> "$GITHUB_OUTPUT"
          echo "teardown=$TEARDOWN" >> "$GITHUB_OUTPUT"
          echo "two_step=$TWO_STEP" >> "$GITHUB_OUTPUT"

          echo "Resolved:"
          echo "  action=$ACTION"
          echo "  image_tag=$IMAGE_TAG"
          echo "  smoke_path=$SMOKE_PATH"
          echo "  teardown=$TEARDOWN"
          echo "  two_step=$TWO_STEP"

      - name: Terraform plan (full)
        id: plan_full
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${{ steps.resolved.outputs.image_tag }}" ]; then
            terraform plan -out=tfplan.binary -var="image_tag=${{ steps.resolved.outputs.image_tag }}"
          else
            terraform plan -out=tfplan.binary
          fi

      - name: Terraform apply (full - fast path)
        id: apply_full
        continue-on-error: true
        run: terraform apply -auto-approve tfplan.binary

      - name: Detect S3 destination validation error
        id: detect_s3_validation
        if: ${{ steps.apply_full.outcome == 'failure' }}
        run: |
          set -euo pipefail
          terraform apply -auto-approve tfplan.binary 2>tf_err.log || true
          if grep -q "Unable to validate the following destination configurations" tf_err.log; then
            echo "hit_validation=true" >> "$GITHUB_OUTPUT"
          else
            echo "hit_validation=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Terraform apply (step 1 - prime S3->SQS prereqs)
        if: |
          steps.resolved.outputs.two_step == 'true' &&
          (steps.apply_full.outcome == 'failure' && steps.detect_s3_validation.outputs.hit_validation == 'true')
        run: |
          set -euo pipefail
          terraform apply -auto-approve \
            -target=module.logging.aws_kms_key.sqs_sse \
            -target=module.logging.aws_kms_alias.sqs_sse \
            -target=module.logging.aws_sqs_queue.alb_logs_events \
            -target=module.logging.aws_sqs_queue_policy.alb_logs_events \
            -target=module.logging.aws_s3_bucket.alb_logs \
            -target=module.logging.aws_s3_bucket.alb_logs_access \
            -target=module.logging.aws_s3_bucket_policy.alb_logs \
            -target=module.logging.aws_s3_bucket_public_access_block.alb_logs \
            -target=module.logging.aws_s3_bucket_public_access_block.alb_logs_access \
            -target=module.logging.aws_s3_bucket_server_side_encryption_configuration.alb_logs \
            -target=module.logging.aws_s3_bucket_server_side_encryption_configuration.alb_logs_access \
            -target=module.logging.aws_s3_bucket_versioning.alb_logs \
            -target=module.logging.aws_s3_bucket_versioning.alb_logs_access

      - name: Wait for AWS propagation
        if: |
          steps.resolved.outputs.two_step == 'true' &&
          (steps.apply_full.outcome == 'failure' && steps.detect_s3_validation.outputs.hit_validation == 'true')
        run: sleep 120

      - name: Terraform plan (full - after prime)
        if: |
          steps.resolved.outputs.two_step == 'true' &&
          (steps.apply_full.outcome == 'failure' && steps.detect_s3_validation.outputs.hit_validation == 'true')
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${{ steps.resolved.outputs.image_tag }}" ]; then
            terraform plan -out=tfplan2.binary -var="image_tag=${{ steps.resolved.outputs.image_tag }}"
          else
            terraform plan -out=tfplan2.binary
          fi

      - name: Terraform apply (full - after prime)
        if: |
          steps.resolved.outputs.two_step == 'true' &&
          (steps.apply_full.outcome == 'failure' && steps.detect_s3_validation.outputs.hit_validation == 'true')
        run: terraform apply -auto-approve tfplan2.binary

      - name: Fail if apply failed for unknown reason
        if: ${{ steps.apply_full.outcome == 'failure' && (steps.detect_s3_validation.outputs.hit_validation != 'true') }}
        run: |
          echo "Terraform apply failed and it was NOT the known S3 destination validation issue."
          exit 1

      - name: Get Terraform outputs
        id: tf_outputs
        run: |
          echo "alb_dns_name=$(terraform output -raw alb_dns_name)" >> "$GITHUB_OUTPUT"

      - name: Show ALB URL
        run: |
          echo "ALB DNS: ${{ steps.tf_outputs.outputs.alb_dns_name }}"
          echo "Test HTTPS: https://${{ steps.tf_outputs.outputs.alb_dns_name }}${{ steps.resolved.outputs.smoke_path }}"
          echo "Test HTTP : http://${{ steps.tf_outputs.outputs.alb_dns_name }}${{ steps.resolved.outputs.smoke_path }}"

  ############################################################
  # DNS (Smoke Test) - environment gate
  ############################################################
  dns:
    name: DNS Smoke Test
    needs: deploy
    if: ${{ needs.deploy.result == 'success' }}
    runs-on: ubuntu-latest
    environment: dns

    steps:
      - name: Show ALB DNS
        run: echo "ALB DNS: ${{ needs.deploy.outputs.alb_dns_name }}"

      - name: Wait for ALB propagation
        run: sleep 60

      - name: Smoke test (HTTPS first, then HTTP)
        run: |
          set -euo pipefail
          PATH_ONLY="/health"

          HTTPS_URL="https://${{ needs.deploy.outputs.alb_dns_name }}${PATH_ONLY}"
          HTTP_URL="http://${{ needs.deploy.outputs.alb_dns_name }}${PATH_ONLY}"

          echo "Testing HTTPS: $HTTPS_URL"
          code=$(curl -k -s -o /dev/null -w "%{http_code}" "$HTTPS_URL" || true)
          echo "HTTPS status: $code"
          if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ]; then
            echo "Smoke test passed on HTTPS."
            exit 0
          fi

          echo "Testing HTTP: $HTTP_URL"
          code=$(curl -s -o /dev/null -w "%{http_code}" "$HTTP_URL" || true)
          echo "HTTP status: $code"
          if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ]; then
            echo "Smoke test passed on HTTP."
            exit 0
          fi

          echo "Smoke test failed (expected 200/301/302)."
          exit 1

  ##########################################################
  # DESTROY (cleanup) - environment gate
  ##########################################################
  destroy:
    name: Destroy (dev)
    needs: dns
    if: |
      github.event_name == 'workflow_dispatch' &&
      (inputs.action == 'destroy' || inputs.teardown_after_test == 'true')
    runs-on: ubuntu-latest
    environment: destroy

    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Verify AWS identity (STS)
        run: aws sts get-caller-identity

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init
        run: terraform init -input=false

      - name: Terraform destroy
        run: terraform destroy -auto-approve
